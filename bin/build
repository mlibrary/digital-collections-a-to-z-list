#!/bin/bash

BINDIR=`dirname $0`
REPODIR=`realpath $BINDIR/..`
REPO=`basename $REPODIR`
WEBDIR=`realpath $BINDIR/../..`

cd $REPODIR
pwd

curl -o .cache/colllist.json "https://quod.lib.umich.edu/cgi/c/collsize/colllist?sponsor=DCC"
md5sum .cache/colllist.json > .cache/prep.md5
if [ -f .cache/last.md5 ]
then
  cmp -s .cache/prep.md5 .cache/last.md5
  if [ $? -eq 0 ]
  then
    echo "-- no changes: punting"
    exit
  fi
fi

mv .cache/prep.md5 .cache/last.md5

npx eleventy --pathprefix a-z --output $WEBDIR
cd $WEBDIR
if [ ! -L ./pagefind ]
then
  echo "-- a-z configure pagefind symlink"
  ln -s "./$REPO/public/pagefind" .
fi

echo "== a-z done"

